<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åŒ–äº¤æ˜“çµ‚ç«¯ v12.0 (User Guide)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #4361ee; --success-bg: #dcfce7; --success-text: #166534; --warning-bg: #fef9c3; --warning-text: #854d0e; --danger-text: #dc2626; --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: #f1f5f9; color: #334155; padding-bottom: 60px; }
        h1 { color: #1e293b; font-size: 1.8rem; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        
        /* --- Ticker --- */
        .ticker-container { width: 100%; overflow: hidden; background-color: #1e293b; color: #fcd34d; padding: 8px 0; margin-bottom: 20px; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); white-space: nowrap; position: relative; }
        .ticker-content { display: inline-block; animation: ticker 30s linear infinite; padding-left: 100%; font-weight: 600; font-size: 0.95rem; }
        .ticker-item { display: inline-block; margin-right: 50px; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- Toast --- */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background-color: #0f172a; color: #fbbf24; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); font-weight: bold; font-size: 0.95rem; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; pointer-events: auto; display: flex; align-items: center; gap: 10px; border: 1px solid #475569; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-icon { font-size: 1.2rem; }

        /* --- Change Badge --- */
        .change-badge { background-color: #7c3aed; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 20px; font-weight: bold; margin-left: 5px; animation: pulse 2s infinite; display: inline-block; vertical-align: middle; cursor: pointer; border: 1px solid #6d28d9; transition: all 0.2s; }
        .change-badge:hover { background-color: #6d28d9; transform: scale(1.05); }
        .change-badge::after { content: " âœ•"; font-size: 0.8em; opacity: 0.7; }
        @keyframes pulse { 0% { opacity: 1; box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); } 70% { opacity: 1; box-shadow: 0 0 0 6px rgba(124, 58, 237, 0); } 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); } }

        /* --- Help Modal Styles --- */
        .help-list { list-style: none; padding: 0; margin: 0; }
        .help-list li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #e2e8f0; }
        .help-list li:last-child { border-bottom: none; }
        .help-title { font-weight: 800; color: var(--primary-color); display: flex; align-items: center; gap: 8px; font-size: 1.05em; margin-bottom: 5px; }
        .help-desc { color: #475569; font-size: 0.95em; line-height: 1.5; }

        /* --- History Log Table --- */
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .log-table th { background: #f1f5f9; text-align: left; padding: 8px; color: #64748b; font-size: 0.85em; position: sticky; top: 0; }
        .log-table td { border-bottom: 1px solid #e2e8f0; padding: 8px; vertical-align: middle; }
        .log-time { color: #64748b; font-size: 0.85em; }
        .log-type-new { color: #16a34a; font-weight: bold; background: #dcfce7; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        .log-type-gone { color: #dc2626; font-weight: bold; background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        .log-type-change { color: #d97706; font-weight: bold; background: #fef3c7; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; margin-top: 10px; }
        .stat-card { background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; text-align: center; transition: all 0.2s; position: relative; }
        .stat-card.clickable { cursor: pointer; border-bottom: 3px solid var(--primary-color); }
        .stat-card.clickable:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.15); background: #eff6ff; }
        
        .stat-label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: #334155; margin-top: 5px; }
        .stat-sub { font-size: 0.85rem; font-weight: bold; margin-top: 2px; }
        .stat-value.pos { color: #16a34a; }
        .stat-value.neg { color: #dc2626; }

        .bankroll-container { display: flex; align-items: center; gap: 10px; background: #eff6ff; padding: 10px; border-radius: 8px; border: 1px solid #bfdbfe; color: #1e40af; margin-bottom: 15px; flex-wrap: wrap;}
        .bankroll-value { font-size: 1.4em; font-weight: 800; margin-left: 5px; }
        
        .btn-group { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 20px; font-size: 14px; cursor: pointer; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 5px; justify-content: center; }
        button:hover { background-color: #304ffe; }
        button.secondary { background-color: #64748b; }
        button.secondary:hover { background-color: #475569; }
        
        .action-cell-content { display: flex; gap: 8px; justify-content: flex-start; align-items: center; }
        button.action-btn { padding: 6px 12px; font-size: 12px; margin: 0; white-space: nowrap; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        button.btn-win { background-color: #16a34a; }
        button.btn-lose { background-color: #dc2626; }
        button.btn-sell { background-color: #f59e0b; color: white; }
        button.btn-fund { background-color: #059669; }
        button.btn-fund:hover { background-color: #047857; }
        
        .filter-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .filter-btn { padding: 6px 12px; font-size: 0.85em; background: #e2e8f0; color: #475569; border-radius: 20px; border: 1px solid #cbd5e1; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { background: #cbd5e1; }
        .filter-btn.active { background: #334155; color: white; border-color: #334155; }

        select { padding: 10px 15px; font-size: 16px; border-radius: 8px; border: 1px solid #cbd5e1; background-color: white; cursor: pointer; }
        .table-container { overflow-x: auto; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; background: white; min-width: 800px; }
        th, td { padding: 12px; text-align: center; font-size: 14px; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        th { background-color: #f8fafc; color: #475569; font-weight: 700; }
        tr.row-buy { background-color: var(--success-bg); }
        tr.row-observe { background-color: var(--warning-bg); }
        
        .export-section { margin-top: 30px; text-align: center; padding-top: 20px; border-top: 1px dashed #cbd5e1; display: flex; justify-content: center; gap: 15px; }
        .btn-export { background-color: #0f172a; color: white; }
        .btn-import { background-color: #475569; color: white; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); box-sizing: border-box; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-content-scroll { overflow-y: auto; flex: 1; }
        .modal-row { margin-bottom: 15px; }
        .modal-row label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-row input, .modal-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .matchup-info { background: #f1f5f9; padding: 8px; border-radius: 6px; margin-bottom: 10px; text-align: center; font-weight: bold; color: #334155; font-size: 0.9em; }

        .odds-type-group { display: flex; gap: 0; border-radius: 6px; overflow: hidden; border: 1px solid #cbd5e1; margin-bottom: 10px; }
        .type-btn { flex: 1; padding: 8px; border: none; background: #f1f5f9; color: #64748b; cursor: pointer; font-size: 0.85em; font-weight: bold; border-right: 1px solid #cbd5e1; border-radius: 0; }
        .type-btn:last-child { border-right: none; }
        .type-btn.active { background: var(--primary-color); color: white; }

        .signal-badge { padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 0.9em; display: inline-block; }
        .badge-buy { background-color: #ffffff; color: var(--success-text); border: 1px solid #86efac; cursor: pointer; text-decoration: underline; }
        .badge-buy:hover { background-color: #dcfce7; }
        .badge-observe { background-color: #ffffff; color: var(--warning-text); border: 1px solid #fde047; }
        
        .section-title { font-size: 1.2rem; font-weight: bold; margin: 20px 0 10px 0; color: #334155; border-left: 5px solid var(--primary-color); padding-left: 10px; }
        .calc-info { font-size: 0.9em; display: flex; justify-content: space-between; margin-top: 5px; }
        .max-btn { cursor: pointer; color: var(--primary-color); font-weight: bold; margin-left: 8px; font-size: 0.9em; }
        
        #chartSection { display: none; margin-top: 30px; }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .stats-table th, .stats-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        .stats-table th { background-color: #f8fafc; color: #64748b; }
    </style>
</head>
<body>
    <h1>ğŸš€ é‡åŒ–äº¤æ˜“çµ‚ç«¯ v12.0</h1>
    
    <div class="ticker-container">
        <div class="ticker-content">
            <span class="ticker-item">ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼šé»æ“Šã€Œæˆ°ç¸¾ã€å¯æŸ¥çœ‹å‹ç‡åˆ†æï¼›é»æ“Šè¨Šè™Ÿæ¬„ä½çš„ã€Œâš¡ç•°å‹•ã€æ¨™ç±¤å¯æ¸…é™¤æç¤ºã€‚</span>
            <span class="ticker-item">âš ï¸ é¢¨éšªæç¤ºï¼šè³ ç‡è®Šæ›´å¾Œè¨Šè™Ÿå¯èƒ½æ¶ˆå¤±ï¼Œæœ€ä½³ä¸‹æ³¨æ™‚æ©Ÿç‚ºé–‹è³½å‰1å°æ™‚ã€‚éæŠ•æ³¨å»ºè­°ï¼Œåƒ…ä¾›æ¸¬è©¦ã€‚</span>
            <span class="ticker-item">ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼šé»æ“Šã€Œæˆ°ç¸¾ã€å¯æŸ¥çœ‹å‹ç‡åˆ†æï¼›é»æ“Šè¨Šè™Ÿæ¬„ä½çš„ã€Œâš¡ç•°å‹•ã€æ¨™ç±¤å¯æ¸…é™¤æç¤ºã€‚</span>
            <span class="ticker-item">âš ï¸ é¢¨éšªæç¤ºï¼šè³ ç‡è®Šæ›´å¾Œè¨Šè™Ÿå¯èƒ½æ¶ˆå¤±ï¼Œæœ€ä½³ä¸‹æ³¨æ™‚æ©Ÿç‚ºé–‹è³½å‰1å°æ™‚ã€‚éæŠ•æ³¨å»ºè­°ï¼Œåƒ…ä¾›æ¸¬è©¦ã€‚</span>
        </div>
    </div>

    <div id="toast-container"></div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <label style="font-weight:bold;">ç•¶å‰æ“ä½œè³½äº‹ï¼š</label>
                <select id="sportSelect" onchange="changeSport()">
                    <option value="nhl">ğŸ’ NHL Hockey</option>
                    <option value="nfl">ğŸˆ NFL Football</option>
                    <option value="ncaaf">ğŸ“ NCAA Football</option>
                    <option value="nba">ğŸ€ NBA Basketball</option>
                </select>
            </div>
            <div id="nbaVersionDisplay" style="font-size: 0.85em; color: #64748b; background: #f1f5f9; padding: 5px 10px; border-radius: 4px;">Loading...</div>
        </div>

        <div class="bankroll-container">
            <span>ğŸ’° <span id="currentSportLabel">NHL</span> è³‡é‡‘æ± :</span>
            <span class="bankroll-value">$<span id="currentBankrollDisplay">0.00</span></span>
            <button class="btn-fund action-btn" style="margin-left: auto;" onclick="openFundModal()">ğŸ¦ è³‡é‡‘ç®¡ç† (å­˜/æ)</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card clickable" onclick="openStatsModal()" title="é»æ“ŠæŸ¥çœ‹è©³ç´°å‹ç‡åˆ†æ">
                <div class="stat-label">æˆ°ç¸¾ (Win Record) ğŸ“Š</div>
                <div class="stat-value" id="statWinRecord">0-0</div>
                <div class="stat-sub" id="statWinRatePct" style="color: #64748b;">(0.0%)</div>
            </div>
            <div class="stat-card clickable" onclick="displayCapitalChart()" title="é»æ“ŠæŸ¥çœ‹è³‡é‡‘èµ°å‹¢åœ–">
                <div class="stat-label">ç¸½ç›ˆè™§ (Total P&L) ğŸ“ˆ</div>
                <div class="stat-value" id="statPnL">$0.00</div>
                <div class="stat-sub" id="statPnLPct">0.00%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æŠ•å ±ç‡ (ROI)</div>
                <div class="stat-value" id="statROI">0.00%</div>
                <div class="stat-sub" style="color:#64748b;">(Turnover based)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€å¤§å›æ’¤ (Max DD)</div>
                <div class="stat-value neg" id="statDrawdown">0.00%</div>
            </div>
        </div>

        <div class="btn-group">
            <button id="refreshBtn" onclick="fetchData()">ğŸ”„ åˆ·æ–°è¨Šè™Ÿ (Live)</button>
            <button class="secondary" onclick="openHelpModal()">ğŸ“˜ ä½¿ç”¨èªªæ˜</button>
            <button class="secondary" onclick="toggleOddsDisplay()">ğŸ”„ åˆ‡æ›è³ ç‡æ ¼å¼</button>
            <button class="secondary" onclick="openHistoryModal()">ğŸ“œ ç•°å‹•ç´€éŒ„</button>
            <button class="secondary" onclick="clearHistory()" style="background-color: #ef4444;">ğŸ—‘ï¸ é‡ç½®</button>
            <span id="status" style="margin-left: 10px; font-weight: bold;"></span>
        </div>
    </div>
    
    <div class="section-title">ğŸ“¡ å¯¦æ™‚è¨Šè™Ÿ (é»æ“Šæ³¨ç¢¼ä¸‹æ³¨)</div>
    <div class="table-container">
        <table id="resultTable">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th><th>å®¢éšŠ</th><th>ä¸»éšŠ</th><th>å®¢å‹ç‡</th><th>ä¸»å‹ç‡</th>
                    <th id="th-v-ml">å®¢ ML</th><th id="th-h-ml">ä¸» ML</th><th>ç­–ç•¥å»ºè­°</th><th>ä¸‹æ³¨</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="section-title">ğŸ“‚ <span id="openBetsTitle">NHL</span> æŒå€‰ (Open Positions)</div>
    <div class="table-container">
        <table id="openBetsTable">
            <thead>
                <tr>
                    <th>ID</th><th>å°è±¡</th><th>æŒæœ‰è‚¡æ•¸</th><th>æˆæœ¬åƒ¹</th><th>ç•¶å‰æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="openBetsBody"></tbody>
        </table>
    </div>

    <div class="section-title" style="border-left-color: #64748b;">ğŸ“œ <span id="closedBetsTitle">NHL</span> æ­·å²å¸³æœ¬ (History)</div>
    <div style="padding-left: 10px; margin-bottom: 5px;">
        <div class="filter-group">
            <button class="filter-btn active" id="filterAll" onclick="setHistoryFilter('all')">å…¨éƒ¨é¡¯ç¤º</button>
            <button class="filter-btn" id="filterSettled" onclick="setHistoryFilter('settled')">åƒ…é¡¯ç¤ºçµç®— (W/L)</button>
            <button class="filter-btn" id="filterSold" onclick="setHistoryFilter('sold')">åƒ…é¡¯ç¤ºè³£å‡º</button>
        </div>
    </div>
    <div class="table-container">
        <table id="closedBetsTable">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th><th>å°è±¡</th><th>æ“ä½œ/çµæœ</th><th>å›å ± (Payout)</th><th>æç›Š (P&L)</th><th>çµé¤˜</th>
                </tr>
            </thead>
            <tbody id="closedBetsBody"></tbody>
        </table>
    </div>

    <div class="export-section">
        <button class="btn-export" onclick="exportData()">ğŸ“¥ åŒ¯å‡ºå®Œæ•´å‚™ä»½ (JSON)</button>
        <label for="importFile" class="btn-import" style="cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px;">
            ğŸ“¤ åŒ¯å…¥å‚™ä»½æª”
        </label>
        <input type="file" id="importFile" accept="*/*" onchange="importData(this)" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;">
    </div>

    <div id="chartSection" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="chartTitle" style="margin: 0; font-size: 1.2rem;">èµ°å‹¢åœ–</h2>
            <button onclick="document.getElementById('chartSection').style.display='none'" class="secondary" style="padding: 5px 10px;">é—œé–‰</button>
        </div>
        <div id="chartContainer"><canvas id="myChart"></canvas></div>
    </div>

    <div id="helpModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0;">ğŸ“˜ ä½¿ç”¨èªªæ˜æ‰‹å†Š</h3>
                <button onclick="closeModal('helpModal')" class="secondary" style="padding: 5px 10px;">âœ•</button>
            </div>
            <div class="modal-content-scroll">
                <ul class="help-list">
                    <li>
                        <div class="help-title">ğŸ² å¦‚ä½•é€²è¡Œä¸‹æ³¨ï¼Ÿ</div>
                        <div class="help-desc">åœ¨ã€Œå¯¦æ™‚è¨Šè™Ÿã€åˆ—è¡¨ä¸­ï¼Œè‹¥å‡ºç¾ç¶ è‰²æ¡†çš„ç­–ç•¥å»ºè­°ï¼Œé»æ“Šè©²æŒ‰éˆ•å³å¯é–‹å•Ÿä¸‹æ³¨è¦–çª—ã€‚è¦–çª—æ”¯æ´ Polymarket (æ©Ÿç‡)ã€ç¾å¼è³ ç‡ (+/-) åŠæ­å¼è³ ç‡ (Decimal) è‡ªå‹•æ›ç®—ã€‚</div>
                    </li>
                    <li>
                        <div class="help-title">ğŸ¦ è³‡é‡‘ç®¡ç†åŠŸèƒ½</div>
                        <div class="help-desc">é»æ“Šä¸Šæ–¹çš„ã€Œè³‡é‡‘ç®¡ç† (å­˜/æ)ã€æŒ‰éˆ•ï¼Œå¯æ¨¡æ“¬å…¥é‡‘æˆ–å‡ºé‡‘ã€‚é€™èƒ½ä¿®æ­£æœ¬é‡‘åŸºæ•¸ï¼Œè®“ã€Œç¸½ç›ˆè™§ %ã€çš„è¨ˆç®—æ›´æº–ç¢ºï¼Œä¸æœƒå› ç‚ºå…¥é‡‘è€Œå°è‡´ç²åˆ©æ¯”ä¾‹è¢«ç¨€é‡‹ã€‚</div>
                    </li>
                    <li>
                        <div class="help-title">ğŸ“Š åœ–è¡¨èˆ‡æ•¸æ“šåˆ†æ</div>
                        <div class="help-desc">
                            â€¢ é»æ“Šã€Œæˆ°ç¸¾ã€å¡ç‰‡ï¼šæŸ¥çœ‹ä¸åŒè³ ç‡å€é–“ï¼ˆå¦‚ 1.x å€ã€2.x å€ï¼‰çš„å‹ç‡çµ±è¨ˆåœ–ã€‚<br>
                            â€¢ é»æ“Šã€Œç¸½ç›ˆè™§ã€å¡ç‰‡ï¼šé–‹å•Ÿè³‡é‡‘æ¬Šç›Šèµ°å‹¢åœ– (Equity Curve)ã€‚
                        </div>
                    </li>
                    <li>
                        <div class="help-title">âš¡ ç•°å‹•åµæ¸¬ç³»çµ±</div>
                        <div class="help-desc">ç³»çµ±æœƒè‡ªå‹•æ¯”å°ç›¤å£è®ŠåŒ–ã€‚è‹¥è¨Šè™Ÿæ¶ˆå¤±æˆ–æ–°å¢ï¼Œæœƒåœ¨è©²å ´æ¬¡æ—é¡¯ç¤ºç´«è‰²çš„ã€Œâš¡ ç•°å‹•ã€æ¨™ç±¤ã€‚æ­¤æ¨™ç±¤ä¸æœƒè‡ªå‹•æ¶ˆå¤±ï¼Œå¿…é ˆç”±æ‚¨æ‰‹å‹•é»æ“Šæ¨™ç±¤ä»¥ç¢ºèªå·²è®€ã€‚</div>
                    </li>
                    <li>
                        <div class="help-title">ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ</div>
                        <div class="help-desc">æ‰€æœ‰æ•¸æ“šçš†å„²å­˜æ–¼ç€è¦½å™¨ä¸­ã€‚å»ºè­°å®šæœŸé»æ“Šã€ŒğŸ“¥ åŒ¯å‡ºå®Œæ•´å‚™ä»½ã€ï¼Œä¸‹è¼‰ JSON æª”æ¡ˆã€‚è‹¥æ›´æ›æ‰‹æ©Ÿæˆ–ç€è¦½å™¨ï¼Œå¯ä½¿ç”¨ã€ŒğŸ“¤ åŒ¯å…¥å‚™ä»½æª”ã€æ¢å¾©æ‰€æœ‰ç´€éŒ„ã€‚</div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0;">ğŸ“Š è³ ç‡å‹ç‡åˆ†æ</h3>
                <button onclick="closeModal('statsModal')" class="secondary" style="padding: 5px 10px;">âœ•</button>
            </div>
            <div class="modal-content-scroll">
                <div style="height: 250px; position: relative; width: 100%;">
                    <canvas id="winRateChart"></canvas>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr><th>è³ ç‡å€é–“ (Decimal)</th><th>å‹/è² </th><th>å‹ç‡ %</th></tr>
                    </thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0;">ğŸ“œ ç•°å‹•ç´€éŒ„ (Signal History)</h3>
                <button onclick="closeModal('historyModal')" class="secondary" style="padding: 5px 10px;">âœ•</button>
            </div>
            <div class="modal-content-scroll" style="max-height: 400px;">
                <table class="log-table">
                    <thead>
                        <tr><th>æ™‚é–“</th><th>å°æˆ°çµ„åˆ</th><th>é¡å‹</th></tr>
                    </thead>
                    <tbody id="historyLogBody"></tbody>
                </table>
            </div>
            <div style="margin-top:10px; text-align:center;">
                <button class="secondary" onclick="clearSignalHistory()" style="width:100%;">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <div id="betModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ“ ç¢ºèªä¸‹æ³¨ (Buy)</h3>
            <div class="matchup-info" id="modalMatchup">Visitor vs Home</div>
            <input type="hidden" id="modalSport">
            <input type="hidden" id="modalTeam">
            <input type="hidden" id="internalPrice">
            
            <div class="modal-row"><label>ä¸‹æ³¨å°è±¡:</label><input type="text" id="modalTeamDisplay" disabled style="background:#f1f5f9; font-weight:bold;"></div>
            
            <div class="modal-row" style="margin-bottom: 10px;">
                <label style="font-size:0.9em; margin-bottom:3px;">è³ ç‡æ ¼å¼ (Odds Format):</label>
                <div class="odds-type-group">
                    <button class="type-btn active" id="btnModePoly" onclick="setOddsMode('polymarket')">Poly (0.xx)</button>
                    <button class="type-btn" id="btnModeAmer" onclick="setOddsMode('american')">ç¾å¼ (+/-)</button>
                    <button class="type-btn" id="btnModeDec" onclick="setOddsMode('decimal')">æ­/è‹± (x.xx)</button>
                </div>
            </div>

            <div class="modal-row"><label>ä¸‹æ³¨é‡‘é¡ (USD):</label><input type="number" id="modalStake" step="1"></div>
            
            <div class="modal-row">
                <label id="priceLabel">è²·å…¥åƒ¹æ ¼ (Price):</label>
                <input type="number" id="modalPrice" step="0.01" oninput="updateBetCalc()">
            </div>
            
            <div class="modal-row" style="background:#f0f9ff; padding:10px; border-radius:4px;">
                <div class="calc-info"><span>é ä¼°è‚¡æ•¸ (Shares):</span><span id="calcShares" style="font-weight:bold;">0.00</span></div>
                <div class="calc-info"><span>æ½›åœ¨ç²åˆ© (Profit):</span><span id="calcProfit" style="font-weight:bold; color:#16a34a;">$0.00</span></div>
            </div>
            <div class="modal-actions"><button class="secondary" onclick="closeModal('betModal')">å–æ¶ˆ</button><button onclick="confirmBet()">âœ… ç¢ºèªè²·å…¥</button></div>
        </div>
    </div>

    <div id="sellModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ’° è³£å‡ºæŒå€‰ (Sell/Cancel)</h3>
            <input type="hidden" id="sellBetId">
            <div class="modal-row"><label>è³£å‡ºå°è±¡:</label><input type="text" id="sellTeamDisplay" disabled style="background:#f1f5f9;"></div>
            <div class="modal-row">
                <label>è³£å‡ºæ•¸é‡ (Shares): <span style="font-size:0.8em; color:#64748b;">(æŒæœ‰: <span id="maxShares">0</span>)</span><span class="max-btn" onclick="setMaxShares()">[MAX]</span></label>
                <input type="number" id="sellShares" step="0.01">
            </div>
            <div class="modal-row"><label>è³£å‡ºåƒ¹æ ¼ (Price):</label><input type="number" id="sellPrice" step="0.01" max="0.99"></div>
            <div class="modal-row" style="background:#fff7ed; padding:10px; border-radius:4px;">
                <div class="calc-info"><span>é ä¼°å›å ± (Payout):</span><span id="calcSellPayout" style="font-weight:bold;">$0.00</span></div>
                <div class="calc-info"><span>æœ¬æ¬¡æç›Š (P&L):</span><span id="calcSellPnL" style="font-weight:bold;">$0.00</span></div>
            </div>
            <div class="modal-actions"><button class="secondary" onclick="closeModal('sellModal')">å–æ¶ˆ</button><button class="btn-sell" onclick="confirmSell()">ğŸ’¸ ç¢ºèªè³£å‡º</button></div>
        </div>
    </div>

    <div id="fundModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ¦ è³‡é‡‘ç®¡ç†</h3>
            <div class="modal-row">
                <label>æ“ä½œé¡å‹:</label>
                <select id="fundType">
                    <option value="deposit">ğŸ“¥ å…¥é‡‘ (Deposit)</option>
                    <option value="withdraw">ğŸ“¤ å‡ºé‡‘ (Withdraw)</option>
                </select>
            </div>
            <div class="modal-row">
                <label>é‡‘é¡ (USD):</label>
                <input type="number" id="fundAmount" step="100" placeholder="0.00">
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal('fundModal')">å–æ¶ˆ</button>
                <button class="btn-fund" onclick="confirmFundAdjustment()">ç¢ºèªåŸ·è¡Œ</button>
            </div>
        </div>
    </div>

    <script>
    const urls = { nhl: 'https://www.dratings.com/predictor/nhl-hockey-predictions/', nfl: 'https://www.dratings.com/predictor/nfl-football-predictions/', ncaaf: 'https://www.dratings.com/predictor/ncaa-football-predictions/', nba: 'https://www.dratings.com/predictor/nba-basketball-predictions/' };
    const winIndex = { nhl: 3, nfl: 3, ncaaf: 2, nba: 2 };
    const mlIndex = { nhl: 4, nfl: 4, ncaaf: 3, nba: 3 };
    let currentSport = 'nhl', history = {}, myChart = null, statsChart = null;
    let oddsMode = localStorage.getItem('pms_odds_mode') || 'polymarket'; 

    function showToast(message) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<span class="toast-icon">âš¡</span><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 4000);
    }

    function mlToNum(mlStr) { if (!mlStr) return null; const cleanStr = mlStr.replace('+', ''); const num = parseInt(cleanStr, 10); return isNaN(num) ? null : num; }
    function getImpliedProb(ml) { if (ml === null) return 0; if (ml > 0) return 100 / (ml + 100); return Math.abs(ml) / (Math.abs(ml) + 100); }
    function calculateWeightedROI(historyList) { if (!historyList || historyList.length === 0) return 0; let weightedSum = 0; let weightSum = 0; for (let i = 0; i < historyList.length; i++) { const weight = i + 1; weightedSum += historyList[i] * weight; weightSum += weight; } return weightedSum / weightSum; }
    
    function getPrevDayStr(dateStr) {
        const parts = dateStr.split('/'); if (parts.length !== 3) return null;
        const current = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
        current.setDate(current.getDate() - 1);
        const m = (current.getMonth() + 1).toString(); const d = current.getDate().toString(); const y = current.getFullYear();
        return `${m}/${d}/${y}`;
    }

    function polyToAmerican(p) { if(p <= 0.01 || p >= 0.99) return 0; if(p < 0.5) return Math.round((1-p)/p * 100); else return Math.round(- (p/(1-p) * 100)); }
    function polyToDecimal(p) { return p <= 0 ? 0 : (1/p).toFixed(2); }
    function americanToPoly(a) { return a > 0 ? 100/(a+100) : Math.abs(a)/(Math.abs(a)+100); }
    function decimalToPoly(d) { return d <= 0 ? 0 : 1/d; }

    const nbaBackendData = { "last_update_date": "2025-12-20", "team_data": { "Charlotte Hornets": { "Home": [-0.260], "Away": [-0.955] }, "Washington Wizards": { "Home": [-0.873], "Away": [-0.488] }, "Toronto Raptors": { "Home": [-0.689], "Away": [] }, "Milwaukee Bucks": { "Home": [], "Away": [-0.627] }, "New Orleans Pelicans": { "Home": [-0.566], "Away": [-0.273] }, "Philadelphia 76ers": { "Home": [0.052], "Away": [-0.549] }, "Sacramento Kings": { "Home": [-0.540], "Away": [] }, "Dallas Mavericks": { "Home": [-0.449], "Away": [] }, "Phoenix Suns": { "Home": [-0.418], "Away": [-0.446] }, "Portland Trail Blazers": { "Home": [-0.425], "Away": [] }, "Miami Heat": { "Home": [], "Away": [-0.359] }, "Cleveland Cavaliers": { "Home": [-0.348], "Away": [] }, "Los Angeles Lakers": { "Home": [], "Away": [-0.309] }, "Brooklyn Nets": { "Home": [-0.293], "Away": [] }, "San Antonio Spurs": { "Home": [-0.236], "Away": [-0.137] }, "Los Angeles Clippers": { "Home": [], "Away": [-0.212] }, "Utah Jazz": { "Home": [-0.185], "Away": [-0.208] }, "Oklahoma City Thunder": { "Home": [], "Away": [-0.204] }, "Detroit Pistons": { "Home": [-0.155], "Away": [] }, "New York Knicks": { "Home": [-0.114], "Away": [0.751] }, "Golden State Warriors": { "Home": [-0.082], "Away": [0.255] }, "Houston Rockets": { "Home": [], "Away": [-0.056] }, "Chicago Bulls": { "Home": [], "Away": [-0.023] }, "Memphis Grizzlies": { "Home": [], "Away": [0.425] }, "Orlando Magic": { "Home": [], "Away": [0.098] }, "Boston Celtics": { "Home": [0.038], "Away": [] }, "Denver Nuggets": { "Home": [0.021], "Away": [] } } };

    function findNbaKey(scrapedName, stateData) {
        if (!stateData) return null;
        if (stateData[scrapedName]) return scrapedName;
        const dbKeys = Object.keys(stateData);
        for (let key of dbKeys) {
            const keyNick = key.split(' ').pop(); 
            if (scrapedName.includes(keyNick) || key.includes(scrapedName)) return key;
        }
        return null; 
    }

    function calculateNbaStrategy(dateStr, visitor, home, vModelProb, hModelProb, vML, hML, bankroll) {
        if (vML === null || hML === null) return { signal: "-", stake: "-", color: "none", highlightTarget: null };
        const dateObj = new Date(dateStr); const month = dateObj.getMonth(); 
        if (month === 9 || month === 1) return { signal: "Month Filter", stake: "PASS", color: "none", highlightTarget: null };
        const vOdds = vML > 0 ? (vML/100)+1 : (100/Math.abs(vML))+1; const hOdds = hML > 0 ? (hML/100)+1 : (100/Math.abs(hML))+1;
        function getPlattProb(rawProbPct) { const pRaw = rawProbPct / 100.0; const pSafe = Math.max(0.01, Math.min(0.99, pRaw)); const L = Math.log(pSafe / (1 - pSafe)); return 1 / (1 + Math.exp(-(1.1035 * L - 0.0954))); }
        const vReal = getPlattProb(vModelProb); const hReal = getPlattProb(hModelProb); const vEV = vReal * vOdds; const hEV = hReal * hOdds;
        let target = null, evValue = 0, teamName = "", location = "";
        if (vEV > 1.08 && vOdds >= 1.50 && vOdds <= 5.00) { target = 'Visitor'; evValue = vEV; teamName = visitor; location = 'Away'; } 
        else if (hEV > 1.08 && hOdds >= 1.50 && hOdds <= 5.00) { if (!(target === 'Visitor' && vEV >= hEV)) { target = 'Home'; evValue = hEV; teamName = home; location = 'Home'; } }
        if (!target) return { signal: "No Value", stake: "-", color: "none", highlightTarget: null };
        const prevDate = getPrevDayStr(dateStr);
        if (prevDate && bettingData.scheduleHistory && bettingData.scheduleHistory[prevDate]) {
            const yesterdayTeams = bettingData.scheduleHistory[prevDate];
            if (yesterdayTeams.includes(teamName)) { return { signal: `âš ï¸ B2B Fatigue (Skip ${teamName})`, stake: "PASS", color: "observe", highlightTarget: target === 'Home' ? 'home' : 'visitor' }; }
        }
        const dbKey = findNbaKey(teamName, nbaBackendData.team_data);
        if (!dbKey) return { signal: `Name Mismatch (${teamName})`, stake: "Check Code", color: "observe", highlightTarget: null };
        const teamHistory = nbaBackendData.team_data[dbKey];
        const historyList = teamHistory ? (teamHistory[location] || []) : [];
        const wROI = calculateWeightedROI(historyList);
        if (wROI < -0.20) { return { signal: `[BL] ${dbKey} (${(wROI*100).toFixed(1)}%)`, stake: "Observe", color: "observe", highlightTarget: location === 'Home' ? 'home' : 'visitor' }; }
        const stakeAmt = bankroll * 0.045; 
        return { signal: `${target === 'Home' ? '[ä¸»]' : '[å®¢]'} ${dbKey} (EV:${evValue.toFixed(2)})`, stake: `$${stakeAmt.toFixed(1)} (4.5%)`, color: "buy", highlightTarget: location === 'Home' ? 'home' : 'visitor' };
    }

    function calculateNhlStrategy(dateStr, visitor, home, vModelProb, hModelProb, vML, hML, bankroll) {
        const dateObj = new Date(dateStr);
        if (!isNaN(dateObj.getTime()) && dateObj.getMonth() === 5) return { signal: "Observe (June)", stake: "0%", color: "observe", highlightTarget: null };
        const vModel = vModelProb / 100.0; const hModel = hModelProb / 100.0;
        if (vML === null || hML === null) return { signal: "-", stake: "-", color: "none", highlightTarget: null };
        const vPrice = getImpliedProb(vML); const hPrice = getImpliedProb(hML);
        const vEdge = vModel - vPrice; const hEdge = hModel - hPrice;
        let result = { type: null, ruleName: null, target: null, trueProb: 0, cap: 0, price: 0 };
        if (hModel >= 0.60 && hModel <= 0.65 && hEdge >= 0.02) result = { type: 'Home', ruleName: 'ğŸš€ Home Ultra', target: home, trueProb: hModel + 0.08, cap: 0.08, price: hPrice };
        else if (hModel >= 0.46 && hModel <= 0.48 && hEdge >= 0.03) result = { type: 'Home', ruleName: 'ğŸ’ Home Hidden Gem', target: home, trueProb: hModel + 0.12, cap: 0.06, price: hPrice };
        else if (hModel >= 0.25 && hModel <= 0.30 && hEdge >= -0.02) result = { type: 'Home', ruleName: 'ğŸ’° Home Underdog', target: home, trueProb: hModel + 0.15, cap: 0.05, price: hPrice };
        else if (hModel >= 0.45 && hModel <= 0.475 && hEdge < 0) result = { type: 'Home', ruleName: 'ğŸ“‰ Home Market Wisdom', target: home, trueProb: hPrice + 0.05, cap: 0.04, price: hPrice };
        else if (hModel >= 0.525 && hModel <= 0.55 && hEdge >= 0.02) result = { type: 'Home', ruleName: 'âœ… Home Mid-Value', target: home, trueProb: hModel + 0.025, cap: 0.03, price: hPrice };
        else if (vModel >= 0.42 && vModel <= 0.44 && vEdge >= 0.05) result = { type: 'Away', ruleName: 'ğŸš€ Away Super Edge', target: visitor, trueProb: vModel + 0.15, cap: 0.06, price: vPrice };
        else if (vModel >= 0.40 && vModel <= 0.45 && vEdge >= 0) result = { type: 'Away', ruleName: 'ğŸ›¡ï¸ Away Stable', target: visitor, trueProb: vModel + 0.04, cap: 0.04, price: vPrice };
        else if (vModel >= 0.25 && vModel <= 0.35 && vEdge < 0) result = { type: 'Away', ruleName: 'ğŸ“‰ Away Wisdom', target: visitor, trueProb: vPrice + 0.08, cap: 0.04, price: vPrice };
        else if (vModel >= 0.60 && vModel <= 0.65 && vEdge >= 0) result = { type: 'Away', ruleName: 'âš”ï¸ Away Favorite', target: visitor, trueProb: vModel + 0.05, cap: 0.04, price: vPrice };
        else return { signal: "-", stake: "-", color: "none", highlightTarget: null };
        const blacklistKeywords = ["Kraken", "Devils", "Penguins", "Utah"];
        if (blacklistKeywords.some(kw => result.target.includes(kw))) return { signal: `${result.ruleName} (Blacklist)`, stake: "Observe", color: "observe", highlightTarget: result.type === 'Home' ? 'home' : 'visitor' };
        if (result.target.includes("Canucks") && result.type === 'Home') return { signal: `${result.ruleName} (Canucks Home)`, stake: "Observe", color: "observe", highlightTarget: 'home' };
        let kellyStake = 0; if (result.price < 1) kellyStake = ((result.trueProb - result.price) / (1.0 - result.price)) * 0.5;
        if (kellyStake <= 0) return { signal: `${result.ruleName} (Neg EV)`, stake: "Skip", color: "none", highlightTarget: null };
        let finalStakePct = Math.min(kellyStake, result.cap); let finalAmt = finalStakePct * bankroll;
        return { signal: (result.type==='Home'?'[ä¸»] ':'[å®¢] ') + result.ruleName, stake: `$${finalAmt.toFixed(1)} (${(finalStakePct * 100).toFixed(2)}%)`, color: "buy", highlightTarget: result.type === 'Home' ? 'home' : 'visitor' };
    }

    function calculateNflStrategy(dateStr, visitor, home, vModelProb, hModelProb, vML, hML, bankroll) {
        const vModel = vModelProb / 100.0; const hModel = hModelProb / 100.0;
        if (vML === null || hML === null) return { signal: "-", stake: "-", color: "none", highlightTarget: null };
        const vPrice = getImpliedProb(vML); const hPrice = getImpliedProb(hML);
        const vDec = vML > 0 ? (vML / 100) + 1 : (100 / Math.abs(vML)) + 1;
        const dateObj = new Date(dateStr); const isJanuary = (!isNaN(dateObj.getTime()) && dateObj.getMonth() === 0);
        let action = { type: null, target: null, cap: 0, reason: "" };
        if (vModel >= 0.50 && vModel < 0.55) action = { type: 'Follow', target: visitor, cap: 0.088, reason: "Guest 50-55% (Follow)" };
        else if (vModel >= 0.55 && vModel < 0.60) action = { type: 'Bet', target: home, cap: 0.05, reason: "Guest 55-60% (Fade)" };
        else if (vModel >= 0.60 && vModel < 0.65) action = { type: 'Pass', target: null, cap: 0, reason: "Guest 60-65% (Pass)" };
        else if (vModel >= 0.65 && vModel < 0.75) action = { type: 'Follow', target: visitor, cap: 0.088, reason: "Guest 65-75% (Follow)" };
        else if (vModel >= 0.75 && vModel < 0.80) action = { type: 'Bet', target: home, cap: 0.10, reason: "Guest 75-80% (Fade)" };
        else if (hModel >= 0.50 && hModel < 0.65) action = { type: 'Bet', target: visitor, cap: 0.08, reason: "Home 50-65% (Gold Zone)" };
        else if (hModel >= 0.65 && hModel < 0.75) action = { type: 'Follow', target: home, cap: 0.053, reason: "Home 65-75% (Follow)" };
        else if (hModel >= 0.75 && hModel < 0.80) action = { type: 'Bet', target: visitor, cap: 0.04, reason: "Home 75-80% (Fade)" };
        else if (hModel >= 0.80 && hModel < 0.90) action = { type: 'Pass', target: null, cap: 0, reason: "Home 80-90% (Trap)" };
        else if (hModel >= 0.90) action = { type: 'Follow', target: home, cap: 0.053, reason: "Home 90%+ (Follow)" };
        const goldenBlacklistKW = ["Jaguars", "Jets", "Broncos"]; let isGoldenDog = false;
        if (vDec >= 2.5 && vDec <= 4.0 && !goldenBlacklistKW.some(kw => visitor.includes(kw))) { isGoldenDog = true; action = { type: 'Golden', target: visitor, cap: 0.08, reason: "ğŸ† Golden Road Dog" }; if (visitor.includes("Steelers") || visitor.includes("Cardinals")) { action.cap = 0.12; action.reason += " (Boost)"; } }
        const toxicKW = ["Jets", "49ers", "Falcons", "Panthers", "Cardinals", "Commanders", "Chargers"];
        if (action.target && toxicKW.some(kw => action.target.includes(kw))) { return { signal: `Toxic Filter (Avoid ${action.target})`, stake: "Observe", color: "observe", highlightTarget: action.target === home ? 'home' : 'visitor' }; }
        if (!action.target || action.type === 'Pass') return { signal: action.reason || "No Signal", stake: "-", color: "none", highlightTarget: null };
        let p = (action.target === visitor) ? vModel : hModel; let q = (action.target === visitor) ? vPrice : hPrice;
        if (isGoldenDog && p < 0.40) p = 0.40;
        if (p <= q) return { signal: `${action.reason} (Neg EV)`, stake: "Skip", color: "none", highlightTarget: null };
        let rawStake = ((p - q) / (1 - q)) * 1.35; if (isJanuary) rawStake = rawStake * 0.5;
        let finalStakePct = Math.min(rawStake, action.cap); if (finalStakePct <= 0) return { signal: `${action.reason} (Low Edge)`, stake: "Skip", color: "none", highlightTarget: null };
        let finalAmt = finalStakePct * bankroll;
        return { signal: (action.target===home?'[ä¸»] ':'[å®¢] ') + action.reason, stake: `$${finalAmt.toFixed(1)} (${(finalStakePct * 100).toFixed(2)}%${isJanuary?" Jan":""})`, color: "buy", highlightTarget: action.target===home ? 'home' : 'visitor' };
    }

    function calculateNcaafStrategy(dateStr, visitor, home, vModelProb, hModelProb, vML, hML, bankroll) {
        if (vML === null || hML === null) return { signal: "-", stake: "-", color: "none", highlightTarget: null };
        const vModel = vModelProb / 100.0; const hModel = hModelProb / 100.0;
        const vPrice = getImpliedProb(vML); const hPrice = getImpliedProb(hML);
        const vEdge = vModel - vPrice; const hEdge = hModel - hPrice;
        const dateObj = new Date(dateStr); const month = dateObj.getMonth(); const day = dateObj.getDay(); const isWeekend = (day === 0 || day === 6);
        let action = { name: null, target: null, type: null, p: 0, c: 0 }; let isTrap = false;
        if (vEdge > 0.15) { if (month !== 8 && month !== 11) { if ((hML < -200 || hML > 100) && hPrice < 0.60) { action = { name: "ğŸª¤ Fade_Trap", target: home, type: 'Home', p: 0.60, c: hPrice }; isTrap = true; } } }
        if ((vEdge > 0.15 || hEdge > 0.15) && !isTrap) return { signal: "High Edge Skip", stake: "-", color: "none", highlightTarget: null };
        const allowedDays = [0, 2, 6];
        if (!action.name && allowedDays.includes(day)) {
            if (hML > 0 && hEdge > 0 && (month === 9 || month === 11) && isWeekend) action = { name: "ğŸ¯ Home_Sniper", target: home, type: 'Home', p: hModel, c: hPrice };
            else if (hModel >= 0.75 && hModel <= 0.85 && hEdge >= 0.01 && month !== 7) action = { name: "ğŸ° Home_Core", target: home, type: 'Home', p: hModel, c: hPrice };
            else if (vModel >= 0.55 && vModel <= 0.60 && vEdge >= 0.02 && vML <= 100 && month !== 8) action = { name: "ğŸšŒ Road_Value", target: visitor, type: 'Away', p: vModel, c: vPrice };
            else if (hModel >= 0.90 && hEdge >= 0.01) action = { name: "âš“ Safe_Anchor", target: home, type: 'Home', p: hModel, c: hPrice };
            else if (hModel >= 0.50 && hModel <= 0.55 && hEdge >= 0.02 && hML <= 100 && month !== 10) action = { name: "ğŸ  Home_Value", target: home, type: 'Home', p: hModel, c: hPrice };
            else if (day === 0 && hModel >= 0.5 && hModel <= 0.8 && hEdge > 0) action = { name: "â˜€ï¸ Sun_Home_Mid", target: home, type: 'Home', p: hModel, c: hPrice };
            else if (day === 0 && vModel >= 0.6 && vModel <= 0.7 && vEdge > 0) action = { name: "â˜€ï¸ Sun_Away_Gap", target: visitor, type: 'Away', p: vModel, c: vPrice };
            else if ((month === 0 || month === 7) && vModel > 0.6 && vEdge > 0) action = { name: "ğŸ—“ï¸ Away_Jan_Aug", target: visitor, type: 'Away', p: vModel, c: vPrice };
        }
        if (!action.name) return { signal: "-", stake: "-", color: "none", highlightTarget: null };
        if (action.p <= action.c) return { signal: `${action.name} (Neg EV)`, stake: "Skip", color: "none", highlightTarget: null };
        let rawKelly = (action.p - action.c) / (1 - action.c); let wagerPct = Math.max(0, rawKelly) * 0.41; let finalAmt = wagerPct * bankroll;
        return { signal: (action.type==='Home'?'[ä¸»] ':'[å®¢] ') + action.name, stake: `$${finalAmt.toFixed(1)} (${(wagerPct * 100).toFixed(2)}%)`, color: "buy", highlightTarget: action.type === 'Home' ? 'home' : 'visitor' };
    }

    let showImpliedOdds = false;
    let historyFilter = 'all'; 
    let bettingData = {
        bankrolls: { nhl: 1000, nfl: 1000, ncaaf: 1000, nba: 1000 },
        principals: { nhl: 1000, nfl: 1000, ncaaf: 1000, nba: 1000 },
        scheduleHistory: {},
        openBets: [],   
        closedBets: [],
        changeLog: [], 
        activeAlerts: {}, 
        savedSignals: {} 
    };

    function loadBettingData() {
        const saved = localStorage.getItem('pms_betting_data_v4'); 
        if (saved) {
            const parsed = JSON.parse(saved);
            bettingData = parsed;
            if (!bettingData.principals) bettingData.principals = { ...bettingData.bankrolls };
            if (!bettingData.scheduleHistory) bettingData.scheduleHistory = {}; 
            if (!bettingData.changeLog) bettingData.changeLog = [];
            if (!bettingData.activeAlerts) bettingData.activeAlerts = {};
            if (!bettingData.savedSignals) bettingData.savedSignals = {};
        }
        updateUI();
    }

    function saveBettingData() {
        localStorage.setItem('pms_betting_data_v4', JSON.stringify(bettingData));
        updateUI();
    }

    function updateUI() {
        document.getElementById('currentSportLabel').textContent = currentSport.toUpperCase();
        document.getElementById('currentBankrollDisplay').textContent = bettingData.bankrolls[currentSport].toFixed(2);
        document.getElementById('openBetsTitle').textContent = currentSport.toUpperCase();
        document.getElementById('closedBetsTitle').textContent = currentSport.toUpperCase();
        renderPortfolio();
        calculateStatistics();
    }

    function calculateStatistics() {
        const relevantBets = bettingData.closedBets.filter(b => b.sport === currentSport && b.result !== 'adjustment');
        const totalBets = relevantBets.length;
        
        let wins = 0; let losses = 0; let totalPnL = 0; let totalInvested = 0; let peak = 0; let maxDrawdown = 0; let runningPnL = 0;
        const sortedBets = [...relevantBets].sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));

        sortedBets.forEach(bet => {
            if (bet.profit > 0) wins++; else if (bet.profit < 0) losses++; 
            totalPnL += bet.profit; totalInvested += bet.stake; runningPnL += bet.profit;
            if (runningPnL > peak) peak = runningPnL;
            let dd = peak - runningPnL; if (dd > maxDrawdown) maxDrawdown = dd;
        });

        const winRate = totalBets > 0 ? (wins / totalBets) * 100 : 0;
        const roi = totalInvested > 0 ? (totalPnL / totalInvested) * 100 : 0;
        const principal = bettingData.principals[currentSport] || 1;
        const pnlPercent = (totalPnL / principal) * 100;
        const peakEquity = principal + peak;
        const ddPercent = peakEquity > 0 ? (maxDrawdown / peakEquity) * 100 : 0;

        document.getElementById('statWinRecord').textContent = `${wins}-${losses}`;
        document.getElementById('statWinRatePct').textContent = `(${winRate.toFixed(1)}%)`;
        const pnlEl = document.getElementById('statPnL'); pnlEl.textContent = (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(2); pnlEl.className = 'stat-value ' + (totalPnL >= 0 ? 'pos' : 'neg');
        const pnlPctEl = document.getElementById('statPnLPct'); pnlPctEl.textContent = (totalPnL >= 0 ? '+' : '') + pnlPercent.toFixed(2) + "% (of Capital)"; pnlPctEl.style.color = totalPnL >= 0 ? '#166534' : '#991b1b';
        const roiEl = document.getElementById('statROI'); roiEl.textContent = (roi >= 0 ? '+' : '') + roi.toFixed(2) + "%"; roiEl.className = 'stat-value ' + (roi >= 0 ? 'pos' : 'neg');
        document.getElementById('statDrawdown').textContent = "-" + ddPercent.toFixed(2) + "%";
    }

    // --- Win Rate Stats Logic ---
    function openStatsModal() {
        const historyList = bettingData.closedBets.filter(b => b.sport === currentSport && b.result !== 'adjustment');
        if (historyList.length === 0) { alert('å°šç„¡è¶³å¤ æ•¸æ“šé€²è¡Œåˆ†æ'); return; }
        const buckets = { '1.0-1.99': { wins: 0, total: 0 }, '2.0-2.99': { wins: 0, total: 0 }, '3.0-3.99': { wins: 0, total: 0 }, '4.0+': { wins: 0, total: 0 } };
        historyList.forEach(b => {
            const p = b.price; if (p > 0.5) { buckets['1.0-1.99'].total++; if(b.profit > 0) buckets['1.0-1.99'].wins++; } else if (p > 0.3333) { buckets['2.0-2.99'].total++; if(b.profit > 0) buckets['2.0-2.99'].wins++; } else if (p > 0.25) { buckets['3.0-3.99'].total++; if(b.profit > 0) buckets['3.0-3.99'].wins++; } else { buckets['4.0+'].total++; if(b.profit > 0) buckets['4.0+'].wins++; }
        });
        const ctx = document.getElementById('winRateChart').getContext('2d'); if (statsChart) statsChart.destroy();
        const labels = Object.keys(buckets); const winRates = labels.map(k => buckets[k].total > 0 ? (buckets[k].wins / buckets[k].total * 100) : 0); const counts = labels.map(k => buckets[k].total);
        statsChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'å‹ç‡ (%)', data: winRates, backgroundColor: 'rgba(67, 97, 238, 0.6)', borderColor: 'rgba(67, 97, 238, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { tooltip: { callbacks: { label: function(context) { const idx = context.dataIndex; return `å‹ç‡: ${context.parsed.y.toFixed(1)}% (${buckets[labels[idx]].wins}/${counts[idx]})`; } } } } } });
        const tbody = document.getElementById('statsTableBody'); tbody.innerHTML = '';
        labels.forEach(k => { const row = document.createElement('tr'); const wr = buckets[k].total > 0 ? (buckets[k].wins / buckets[k].total * 100).toFixed(1) : '0.0'; row.innerHTML = `<td>${k}</td><td>${buckets[k].wins}/${buckets[k].total - buckets[k].wins}</td><td style="font-weight:bold; color:${parseFloat(wr)>=50?'#16a34a':'#dc2626'}">${wr}%</td>`; tbody.appendChild(row); });
        document.getElementById('statsModal').style.display = 'flex';
    }

    // --- Help Modal Logic ---
    function openHelpModal() { document.getElementById('helpModal').style.display = 'flex'; }

    // --- History & Alerts Logic ---
    function openHistoryModal() {
        const tbody = document.getElementById('historyLogBody'); tbody.innerHTML = '';
        const logs = [...bettingData.changeLog].reverse(); 
        if (logs.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">å°šç„¡ç•°å‹•ç´€éŒ„</td></tr>'; }
        else {
            logs.forEach(log => {
                const tr = document.createElement('tr');
                let typeClass = 'log-type-change';
                if(log.type.includes('æ–°å¢')) typeClass = 'log-type-new';
                if(log.type.includes('æ¶ˆå¤±')) typeClass = 'log-type-gone';
                tr.innerHTML = `<td class="log-time">${new Date(log.timestamp).toLocaleString()}</td><td>${log.match}</td><td><span class="${typeClass}">${log.type}</span></td>`;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('historyModal').style.display = 'flex';
    }

    function clearSignalHistory() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç•°å‹•æ­·å²ç´€éŒ„å—ï¼Ÿ')) { bettingData.changeLog = []; saveBettingData(); openHistoryModal(); }
    }

    function clearAlert(matchKey) {
        if (bettingData.activeAlerts[matchKey]) {
            delete bettingData.activeAlerts[matchKey];
            saveBettingData();
            fetchData(); // Re-render
        }
    }

    function openFundModal() { document.getElementById('fundModal').style.display = 'flex'; document.getElementById('fundAmount').value = ''; }
    function confirmFundAdjustment() {
        const type = document.getElementById('fundType').value; const amount = parseFloat(document.getElementById('fundAmount').value);
        if (!amount || amount <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }
        if (type === 'deposit') { bettingData.bankrolls[currentSport] += amount; bettingData.principals[currentSport] += amount; } else { if (amount > bettingData.bankrolls[currentSport]) { alert('è³‡é‡‘ä¸è¶³'); return; } bettingData.bankrolls[currentSport] -= amount; bettingData.principals[currentSport] -= amount; }
        bettingData.closedBets.push({ date: new Date().toLocaleDateString(), sport: currentSport, team: type === 'deposit' ? 'ğŸ’° Deposit' : 'ğŸ’¸ Withdraw', stake: 0, price: 0, result: 'adjustment', profit: 0, finalBankroll: bettingData.bankrolls[currentSport], timestamp: Date.now() });
        saveBettingData(); closeModal('fundModal'); alert('è³‡é‡‘èª¿æ•´å®Œæˆ');
    }

    function displayCapitalChart() {
        const historyList = bettingData.closedBets.filter(b => b.sport === currentSport).sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
        if (historyList.length === 0) { alert('å°šç„¡ç´€éŒ„ï¼Œç„¡æ³•ç¹ªè£½èµ°å‹¢åœ–'); return; }
        const labels = []; const data = []; historyList.forEach((b, index) => { labels.push(`${index+1} (${b.date})`); data.push(b.finalBankroll); });
        document.getElementById('chartTitle').textContent = `ğŸ’° ${currentSport.toUpperCase()} è³‡é‡‘æ¬Šç›Šæ›²ç·š (Equity Curve)`;
        document.getElementById('chartSection').style.display = 'block';
        const ctx = document.getElementById('myChart').getContext('2d'); if (myChart) myChart.destroy();
        const gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(75, 192, 192, 0.6)'); gradient.addColorStop(1, 'rgba(75, 192, 192, 0.05)');
        myChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'ç¸½è³‡é‡‘ (Bankroll)', data: data, borderColor: '#16a34a', backgroundColor: gradient, borderWidth: 2, fill: true, tension: 0.3, pointRadius: 3 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } } });
        document.getElementById('chartSection').scrollIntoView({ behavior: 'smooth' });
    }

    function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(bettingData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "pms_FULL_backup_" + new Date().toISOString().slice(0,10) + ".json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
    function importData(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { const imported = JSON.parse(e.target.result); if (confirm('ç¢ºå®šè¦åŒ¯å…¥æ­¤å‚™ä»½æª”å—ï¼Ÿé€™å°‡è¦†è“‹ç•¶å‰æ‰€æœ‰æ•¸æ“šï¼')) { bettingData = imported; if (!bettingData.principals) bettingData.principals = { ...bettingData.bankrolls }; if (!bettingData.scheduleHistory) bettingData.scheduleHistory = {}; if (!bettingData.changeLog) bettingData.changeLog = []; if (!bettingData.activeAlerts) bettingData.activeAlerts = {}; if (!bettingData.savedSignals) bettingData.savedSignals = {}; saveBettingData(); alert('åŒ¯å…¥æˆåŠŸï¼'); } } catch (err) { alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
        };
        reader.readAsText(file); input.value = ''; 
    }

    function setHistoryFilter(type) { historyFilter = type; document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); if (type === 'all') document.getElementById('filterAll').classList.add('active'); if (type === 'settled') document.getElementById('filterSettled').classList.add('active'); if (type === 'sold') document.getElementById('filterSold').classList.add('active'); renderPortfolio(); }
    function setOddsMode(mode) { oddsMode = mode; localStorage.setItem('pms_odds_mode', mode); document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active')); if(mode === 'polymarket') document.getElementById('btnModePoly').classList.add('active'); if(mode === 'american') document.getElementById('btnModeAmer').classList.add('active'); if(mode === 'decimal') document.getElementById('btnModeDec').classList.add('active'); const input = document.getElementById('modalPrice'); const internalPrice = parseFloat(document.getElementById('internalPrice').value) || 0.5; if (mode === 'polymarket') { document.getElementById('priceLabel').textContent = "è²·å…¥åƒ¹æ ¼ (Price):"; input.step = "0.01"; input.value = internalPrice.toFixed(2); } else if (mode === 'american') { document.getElementById('priceLabel').textContent = "ç¾å¼è³ ç‡ (Odds):"; input.step = "1"; input.value = polyToAmerican(internalPrice); } else if (mode === 'decimal') { document.getElementById('priceLabel').textContent = "æ­/è‹±è³ ç‡ (Decimal):"; input.step = "0.01"; input.value = polyToDecimal(internalPrice); } updateBetCalc(); }
    function updateBetCalc() { const stake = parseFloat(document.getElementById('modalStake').value) || 0; const rawInput = parseFloat(document.getElementById('modalPrice').value); let finalPrice = 0.5; if (!isNaN(rawInput)) { if (oddsMode === 'polymarket') finalPrice = rawInput; else if (oddsMode === 'american') finalPrice = americanToPoly(rawInput); else if (oddsMode === 'decimal') finalPrice = decimalToPoly(rawInput); } if (finalPrice <= 0) finalPrice = 0.01; if (finalPrice >= 1) finalPrice = 0.99; document.getElementById('internalPrice').value = finalPrice; const shares = stake / finalPrice; const profit = shares - stake; document.getElementById('calcShares').textContent = shares.toFixed(2); document.getElementById('calcProfit').textContent = '$' + profit.toFixed(2); }
    function openBetModal(team, stake, price, visitor, home, targetType) { document.getElementById('modalSport').value = currentSport; document.getElementById('modalTeam').value = team; const typeSuffix = targetType === 'Home' ? '(ä¸»)' : '(å®¢)'; document.getElementById('modalTeamDisplay').value = `${team} ${typeSuffix}`; document.getElementById('modalMatchup').textContent = `${visitor} (å®¢) vs ${home} (ä¸»)`; document.getElementById('modalStake').value = Math.round(stake); document.getElementById('internalPrice').value = price || 0.5; setOddsMode(oddsMode); document.getElementById('betModal').style.display = 'flex'; }
    function setMaxShares() { const betId = document.getElementById('sellBetId').value; const bet = bettingData.openBets.find(b => b.id == betId); if(bet) { document.getElementById('sellShares').value = bet.shares; document.getElementById('sellShares').dispatchEvent(new Event('input')); } }
    function openSellModal(betId) { const bet = bettingData.openBets.find(b => b.id === betId); if(!bet) return; document.getElementById('sellBetId').value = betId; document.getElementById('sellTeamDisplay').value = bet.team; document.getElementById('maxShares').textContent = bet.shares.toFixed(2); document.getElementById('sellShares').value = bet.shares.toFixed(2); document.getElementById('sellPrice').value = 0.50; const updateSellCalc = () => { const shares = parseFloat(document.getElementById('sellShares').value) || 0; const price = parseFloat(document.getElementById('sellPrice').value) || 0; const payout = shares * price; const costBasis = shares * bet.price; const pnl = payout - costBasis; document.getElementById('calcSellPayout').textContent = '$' + payout.toFixed(2); const pnlSpan = document.getElementById('calcSellPnL'); pnlSpan.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2); pnlSpan.style.color = pnl >= 0 ? '#16a34a' : '#dc2626'; }; document.getElementById('sellShares').oninput = updateSellCalc; document.getElementById('sellPrice').oninput = updateSellCalc; updateSellCalc(); document.getElementById('sellModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function confirmBet() { const sport = document.getElementById('modalSport').value; const team = document.getElementById('modalTeam').value; const teamDisplay = document.getElementById('modalTeamDisplay').value; const stake = parseFloat(document.getElementById('modalStake').value); const price = parseFloat(document.getElementById('internalPrice').value); if (!stake || !price || price <= 0 || price >= 1) { alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡èˆ‡åƒ¹æ ¼"); return; } if (bettingData.bankrolls[sport] < stake) { alert("è³‡é‡‘ä¸è¶³ï¼"); return; } bettingData.bankrolls[sport] -= stake; const shares = stake / price; const bet = { id: Date.now(), sport: sport, date: new Date().toLocaleDateString(), team: teamDisplay, stake: stake, price: price, shares: shares, timestamp: Date.now() }; bettingData.openBets.push(bet); saveBettingData(); closeModal('betModal'); alert("ä¸‹æ³¨æˆåŠŸï¼"); }
    function confirmSell() { const betId = parseInt(document.getElementById('sellBetId').value); const sellShares = parseFloat(document.getElementById('sellShares').value); const sellPrice = parseFloat(document.getElementById('sellPrice').value); const betIdx = bettingData.openBets.findIndex(b => b.id === betId); if(betIdx === -1) return; const bet = bettingData.openBets[betIdx]; if(sellShares > bet.shares + 0.0001) { alert("è³£å‡ºæ•¸é‡è¶…éæŒæœ‰æ•¸é‡ï¼"); return; } const payout = sellShares * sellPrice; const costBasis = sellShares * bet.price; const profit = payout - costBasis; bettingData.bankrolls[bet.sport] += payout; const historyRecord = { date: new Date().toLocaleDateString(), sport: bet.sport, team: bet.team + (sellShares < bet.shares - 0.0001 ? " (Partial)" : ""), stake: costBasis, price: sellPrice, result: "sold", profit: profit, finalBankroll: bettingData.bankrolls[bet.sport], timestamp: Date.now() }; bettingData.closedBets.push(historyRecord); if(Math.abs(sellShares - bet.shares) < 0.0001) { bettingData.openBets.splice(betIdx, 1); } else { bet.shares -= sellShares; bet.stake -= costBasis; } saveBettingData(); closeModal('sellModal'); }
    function settleBet(id, result) { const idx = bettingData.openBets.findIndex(b => b.id === id); if (idx === -1) return; const bet = bettingData.openBets[idx]; let profit = 0; let payout = 0; if (result === 'win') { payout = bet.shares * 1.00; profit = payout - bet.stake; bettingData.bankrolls[bet.sport] += payout; } else { profit = -bet.stake; } const closedBet = { date: new Date().toLocaleDateString(), sport: bet.sport, team: bet.team, stake: bet.stake, price: bet.price, result: result, profit: profit, finalBankroll: bettingData.bankrolls[bet.sport], timestamp: Date.now() }; bettingData.closedBets.push(closedBet); bettingData.openBets.splice(idx, 1); saveBettingData(); }
    function renderPortfolio() { const openBody = document.getElementById('openBetsBody'); openBody.innerHTML = ''; const currentOpenBets = bettingData.openBets.filter(b => b.sport === currentSport); currentOpenBets.forEach(bet => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${bet.id.toString().slice(-4)}</td><td><b>${bet.team}</b></td><td>${bet.shares.toFixed(2)}</td><td>${bet.price.toFixed(2)}</td><td><div class="action-cell-content"><button class="action-btn btn-win" onclick="settleBet(${bet.id}, 'win')">âœ… Win</button><button class="action-btn btn-lose" onclick="settleBet(${bet.id}, 'lose')">âŒ Lose</button><button class="action-btn btn-sell" onclick="openSellModal(${bet.id})">ğŸ’° Sell</button></div></td>`; openBody.appendChild(tr); }); const closedBody = document.getElementById('closedBetsBody'); closedBody.innerHTML = ''; const currentClosedBets = bettingData.closedBets.filter(b => b.sport === currentSport); let filteredBets = currentClosedBets; if (historyFilter === 'settled') filteredBets = currentClosedBets.filter(b => b.result !== 'sold' && b.result !== 'adjustment'); if (historyFilter === 'sold') filteredBets = currentClosedBets.filter(b => b.result === 'sold'); const recentClosed = [...filteredBets].reverse().slice(0, 10); recentClosed.forEach(bet => { const tr = document.createElement('tr'); if (bet.result === 'adjustment') { tr.innerHTML = `<td>${bet.date}</td><td colspan="4" style="text-align:center; font-weight:bold; color:#0f172a;">${bet.team}</td><td>$${bet.finalBankroll.toFixed(1)}</td>`; } else { const color = bet.profit > 0 ? '#16a34a' : '#dc2626'; let actionType = bet.result.toUpperCase(); if (bet.result === 'sold') actionType = '<span style="color:#f59e0b">SOLD</span>'; else if (bet.result === 'win') actionType = '<span style="color:#16a34a">WIN</span>'; else actionType = '<span style="color:#dc2626">LOSE</span>'; tr.innerHTML = `<td>${bet.date}</td><td>${bet.team}</td><td>${actionType}</td><td>$${(bet.profit + bet.stake).toFixed(2)}</td><td style="color:${color}; font-weight:bold;">${bet.profit > 0 ? '+' : ''}$${bet.profit.toFixed(1)}</td><td>$${bet.finalBankroll.toFixed(1)}</td>`; } closedBody.appendChild(tr); }); }
    function toggleOddsDisplay() { showImpliedOdds = !showImpliedOdds; fetchData(); }
    function changeSport() { currentSport = document.getElementById('sportSelect').value; updateUI(); fetchData(); } 
    function clearHistory() { if (confirm('è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰è³‡é‡‘èˆ‡ä¸‹æ³¨ç´€éŒ„ï¼')) { localStorage.removeItem('pms_betting_data_v4'); location.reload(); } }

    async function fetchData() {
        const sport = currentSport; const url = urls[sport]; const status = document.getElementById('status');
        const tbody = document.querySelector('#resultTable tbody'); 
        
        const currentCash = bettingData.bankrolls[sport];
        const totalOpenStake = bettingData.openBets.filter(b => b.sport === sport).reduce((sum, b) => sum + b.stake, 0);
        const effectiveBankroll = currentCash + totalOpenStake;

        status.textContent = 'æ›´æ–°ä¸­...'; tbody.innerHTML = '';

        try {
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error('Network Error');
            const html = await response.text();
            const parser = new DOMParser(); const doc = parser.parseFromString(html, 'text/html');
            const table = doc.querySelector('table');
            if (!table || table.querySelectorAll('tbody tr').length === 0) throw new Error('ç„¡æ¯”è³½è³‡æ–™');
            
            document.getElementById('th-v-ml').textContent = showImpliedOdds ? 'å®¢ éš±å«ç‡' : 'å®¢ ML';
            document.getElementById('th-h-ml').textContent = showImpliedOdds ? 'ä¸» éš±å«ç‡' : 'ä¸» ML';

            const rows = table.querySelectorAll('tbody tr');
            
            if (sport === 'nba') {
                if (!bettingData.scheduleHistory) bettingData.scheduleHistory = {};
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td'); if (cells.length < 2) return;
                    const dateRaw = cells[0].textContent.trim().replace(/\[|\]/g, '').match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                    if (!dateRaw) return;
                    const gameDate = dateRaw[0]; const teamLinks = cells[1].querySelectorAll('a'); if (teamLinks.length < 2) return;
                    const vis = teamLinks[0].textContent.trim(); const hom = teamLinks[1].textContent.trim();
                    if (!bettingData.scheduleHistory[gameDate]) bettingData.scheduleHistory[gameDate] = [];
                    if (!bettingData.scheduleHistory[gameDate].includes(vis)) bettingData.scheduleHistory[gameDate].push(vis);
                    if (!bettingData.scheduleHistory[gameDate].includes(hom)) bettingData.scheduleHistory[gameDate].push(hom);
                });
                saveBettingData(); 
            }

            let changesCount = 0;
            let currentSignalState = {};

            rows.forEach(row => {
                const cells = row.querySelectorAll('td'); if (cells.length < 4) return;
                const date = cells[0].textContent.trim().replace(/\[|\]/g, '').match(/(\d{1,2}\/\d{1,2}\/\d{4})/)[0];
                const teamLinks = cells[1].querySelectorAll('a'); if (teamLinks.length < 2) return;
                const visitor = teamLinks[0].textContent.trim(); const home = teamLinks[1].textContent.trim();
                const vProbStr = cells[winIndex[sport]].textContent.trim().match(/([\d.]+%)/g)[0];
                const hProbStr = cells[winIndex[sport]].textContent.trim().match(/([\d.]+%)/g)[1];
                const mlText = cells[mlIndex[sport]].textContent.trim(); const mlMatches = mlText.match(/([+-]\d+)/g);
                let vMLStr = '', hMLStr = '';
                if (mlMatches && mlMatches.length >= 4) { vMLStr = mlMatches[2]; hMLStr = mlMatches[3]; } else if (mlMatches && mlMatches.length >= 2) { vMLStr = mlMatches[0]; hMLStr = mlMatches[1]; }
                const vProbVal = parseFloat(vProbStr); const hProbVal = parseFloat(hProbStr); const vMLVal = mlToNum(vMLStr); const hMLVal = mlToNum(hMLStr);
                
                let strategyRes;
                if (sport === 'nhl') strategyRes = calculateNhlStrategy(date, visitor, home, vProbVal, hProbVal, vMLVal, hMLVal, effectiveBankroll);
                else if (sport === 'nfl') strategyRes = calculateNflStrategy(date, visitor, home, vProbVal, hProbVal, vMLVal, hMLVal, effectiveBankroll);
                else if (sport === 'ncaaf') strategyRes = calculateNcaafStrategy(date, visitor, home, vProbVal, hProbVal, vMLVal, hMLVal, effectiveBankroll);
                else if (sport === 'nba') strategyRes = calculateNbaStrategy(date, visitor, home, vProbVal, hProbVal, vMLVal, hMLVal, effectiveBankroll);

                const matchKey = `${date}_${visitor}_${home}`;
                const currentSig = strategyRes.signal;
                currentSignalState[matchKey] = currentSig;

                if (bettingData.savedSignals[matchKey] && bettingData.savedSignals[matchKey] !== currentSig) {
                    let type = "è¨Šè™Ÿè®Šæ›´";
                    if(bettingData.savedSignals[matchKey] === '-' || bettingData.savedSignals[matchKey] === 'No Value') type = "æ–°å¢è¨Šè™Ÿ";
                    else if(currentSig === '-' || currentSig === 'No Value') type = "è¨Šè™Ÿæ¶ˆå¤±";
                    
                    bettingData.changeLog.push({ timestamp: Date.now(), match: `${visitor} vs ${home}`, type: type });
                    bettingData.activeAlerts[matchKey] = true;
                    changesCount++;
                }

                const tr = document.createElement('tr');
                if (strategyRes.color === 'buy') tr.className = 'row-buy'; else if (strategyRes.color === 'observe') tr.className = 'row-observe';
                
                let badgeClass = strategyRes.color === 'buy' ? 'signal-badge badge-buy' : (strategyRes.color === 'observe' ? 'signal-badge badge-observe' : 'signal-none');
                
                let stakeHtml = strategyRes.stake;
                let modalAttr = "";
                if (strategyRes.color === 'buy') {
                    const amtMatch = (typeof strategyRes.stake === 'string') ? strategyRes.stake.match(/\$([\d.]+)/) : null;
                    const amt = amtMatch ? parseFloat(amtMatch[1]) : 0;
                    const targetTeam = strategyRes.highlightTarget === 'visitor' ? visitor : home;
                    const targetType = strategyRes.highlightTarget === 'visitor' ? 'Away' : 'Home'; 
                    const impliedPrice = strategyRes.highlightTarget === 'visitor' ? (vMLVal ? getImpliedProb(vMLVal) : 0.5) : (hMLVal ? getImpliedProb(hMLVal) : 0.5);
                    modalAttr = `onclick="openBetModal('${targetTeam.replace(/'/g, "\\'")}', ${amt}, ${impliedPrice.toFixed(2)}, '${visitor.replace(/'/g, "\\'")}', '${home.replace(/'/g, "\\'")}', '${targetType}')"`;
                    stakeHtml = `<span class="badge-buy" ${modalAttr}>${strategyRes.stake}</span>`;
                }

                let signalDisplay = `<span class="${badgeClass}" ${strategyRes.color === 'buy' ? modalAttr : ''}>${strategyRes.signal}</span>`;
                if (bettingData.activeAlerts[matchKey]) {
                    signalDisplay += ` <span class="change-badge" onclick="clearAlert('${matchKey}')">âš¡ ç•°å‹•</span>`;
                }

                let vColor = '', hColor = '';
                if (sport === 'nhl') { const bl = ["Kraken", "Devils", "Penguins", "Utah"]; if(bl.some(k=>visitor.includes(k))) vColor='#dc2626'; if(bl.some(k=>home.includes(k))) hColor='#dc2626'; if(home.includes("Canucks")) hColor='#dc2626'; }
                else if (sport === 'nfl') { const tx = ["Jets", "49ers", "Falcons", "Panthers", "Cardinals", "Commanders", "Chargers"]; if(tx.some(k=>visitor.includes(k))) vColor='#dc2626'; if(tx.some(k=>home.includes(k))) hColor='#dc2626'; }
                else if (sport === 'nba') { 
                    const vKey=findNbaKey(visitor,nbaBackendData.team_data); if(vKey&&calculateWeightedROI(nbaBackendData.team_data[vKey]['Away'])<-0.20) vColor='#dc2626';
                    const hKey=findNbaKey(home,nbaBackendData.team_data); if(hKey&&calculateWeightedROI(nbaBackendData.team_data[hKey]['Home'])<-0.20) hColor='#dc2626';
                }
                const vNameDisplay = vColor ? `<span style="color:${vColor};font-weight:900;">${visitor}</span>` : visitor;
                const hNameDisplay = hColor ? `<span style="color:${hColor};font-weight:900;">${home}</span>` : home;

                let vOddsDisplay = vMLStr || 'N/A'; let hOddsDisplay = hMLStr || 'N/A';
                if (showImpliedOdds) { if (vMLVal !== null) vOddsDisplay = (getImpliedProb(vMLVal)*100).toFixed(2)+'%'; if (hMLVal !== null) hOddsDisplay = (getImpliedProb(hMLVal)*100).toFixed(2)+'%'; }

                tr.innerHTML = `<td>${date}</td><td>${vNameDisplay}</td><td>${hNameDisplay}</td><td>${vProbStr}</td><td>${hProbStr}</td><td>${vOddsDisplay}</td><td>${hOddsDisplay}</td><td>${signalDisplay}</td><td>${stakeHtml}</td>`;
                tbody.appendChild(tr);
            });

            if (Object.keys(bettingData.savedSignals).length > 0 && changesCount > 0) {
                showToast(`åµæ¸¬åˆ° ${changesCount} å ´æ¯”è³½è¨Šè™Ÿç™¼ç”Ÿç•°å‹•ï¼`);
                saveBettingData(); 
            }
            bettingData.savedSignals = currentSignalState;
            saveBettingData(); 

            status.textContent = 'âœ…';
        } catch (err) { 
            status.textContent = 'âŒ ' + err.message; console.error(err); 
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        if (typeof nbaBackendData !== 'undefined') document.getElementById('nbaVersionDisplay').textContent = 'ğŸ“… NBA æ•¸æ“šç‰ˆæœ¬ï¼š' + nbaBackendData.last_update_date;
        loadBettingData(); 
        fetchData(); 
        setInterval(fetchData, 3600000); 
    });
</script>
</body>
</html>
